name: RDP-Windows11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure RDP Access
        run: |
          # ØªÙ…ÙƒÙŠÙ† RDP ÙˆØªØ¹Ø·ÙŠÙ„ NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          $Password = "Rdp@12345"
          $Secure = ConvertTo-SecureString $Password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $Secure -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          echo "Username: RDP"
          echo "Password: $Password"

      - name: Enable Desktop Experience + DirectX + Audio
        run: |
          dism /online /enable-feature /featurename:ServerCore-FullServer /all
          dism /online /enable-feature /featurename:Server-Gui-Mgmt-Infra /all
          dism /online /enable-feature /featurename:Server-Gui-Shell /all
          dism /online /enable-feature /featurename:Microsoft-Windows-DirectX-Core /all
          sc config Audiosrv start= auto
          sc start Audiosrv
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Shell /t REG_SZ /d "explorer.exe" /f

      - name: Install DirectX and Visual C++ Runtimes
        run: |
          Invoke-WebRequest "https://download.microsoft.com/download/1/1/9/11905C7E-FB08-4C83-8F2D-3B1E9E4A59E3/directx_Jun2010_redist.exe" -OutFile "$env:TEMP\dx.exe"
          Start-Process "$env:TEMP\dx.exe" -ArgumentList "/Q /T:$env:TEMP\dx" -Wait
          Start-Process "$env:TEMP\dx\DXSETUP.exe" -ArgumentList "/silent" -Wait
          Remove-Item "$env:TEMP\dx" -Recurse -Force

          Invoke-WebRequest "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "$env:TEMP\vc.exe"
          Start-Process "$env:TEMP\vc.exe" -ArgumentList "/install /quiet /norestart" -Wait

      - name: Optimize Performance
        run: |
          powercfg /setactive SCHEME_MIN
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v LargeSystemCache /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v SecondLevelDataCache /t REG_DWORD /d 256 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall set allprofiles state off

      - name: Display Connection Info
        run: |
          $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.InterfaceAlias -like "Ethernet*" -and $_.IPAddress -notlike "169.*" }).IPAddress
          Write-Host "=============================="
          Write-Host "âœ… RDP Server is Ready!"
          Write-Host "ðŸ–¥ï¸  Address: $ip"
          Write-Host "ðŸ‘¤ Username: RDP"
          Write-Host "ðŸ”‘ Password: Rdp@12345"
          Write-Host "=============================="
          Write-Host ""
          Write-Host "To connect: use Remote Desktop (mstsc) -> enter IP, user, and password above"

      - name: Keep RDP Session Alive
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] RDP Active â€” running as Windows 11-like system."
            Start-Sleep -Seconds 300
          }
